<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Unified App (Register & Confirm)</title>
    <style>
        /* CSS kh√¥ng thay ƒë·ªïi */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin-top: 0; font-size: 1.2rem; color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; color: #555; }
        input, button { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button.main-action { background: #28a745; }
        button:disabled { background: #ccc; }
        #log-container { background: #222; color: #fff; font-family: 'Courier New', Courier, monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { font-size: 0.9rem; }
        .status-icon { font-size: 1.2rem; }
        .hidden { display: none; }
        .settings-toggle { text-align: center; color: #007bff; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="card">
        <h2>‚öôÔ∏è C√†i ƒë·∫∑t</h2>
        <label>Chu·ªói Cookie (d√πng chung):</label>
        <input type="text" id="cookie" placeholder="ASP.NET_SessionId=..." onchange="saveConfig()">
        <div id="custom-urls" class="hidden">
            <label>Auto Register Worker URL (T√πy ch·ªânh):</label>
            <input type="text" id="registerWorkerUrl" onchange="saveConfig()">
            <label>Final Confirm Worker URL (T√πy ch·ªânh):</label>
            <input type="text" id="confirmWorkerUrl" onchange="saveConfig()">
        </div>
        <div class="settings-toggle" onclick="toggleCustomUrls()">S·ª≠ d·ª•ng Worker URL t√πy ch·ªânh</div>
    </div>

    <div class="card">
        <h2>üîç Tra c·ª©u & Th·ª±c thi</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="packageGroup" placeholder="Nh·∫≠p Package Group" style="flex: 1; margin-bottom: 0;">
            <button onclick="fetchAndDisplayPackages()" style="width: 120px; margin-bottom: 0;">T·∫£i DS</button>
        </div>
        <div id="package-list"></div>
        <div id="action-buttons" style="display: none; margin-top: 15px;">
            <button onclick="runFullProcess()" class="main-action">üöÄ B·∫Øt ƒë·∫ßu Quy tr√¨nh (Register -> Confirm)</button>
        </div>
        <div id="log-container"></div>
    </div>

    <script>
        const DEFAULT_REGISTER_URL = "https://auto-register.chiscoong-cloudflare-com.workers.dev/";
        const DEFAULT_CONFIRM_URL = "https://mes-final-confirm.chiscoong-cloudflare-com.workers.dev/";

        // *** THAY ƒê·ªîI 1: Th√™m h√†m delay ***
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // ... (c√°c h√†m kh√°c kh√¥ng ƒë·ªïi cho ƒë·∫øn runFullProcess)
        window.onload = function() { /*...*/ }
        function saveConfig() { /*...*/ }
        function toggleCustomUrls() { /*...*/ }
        function getWorkerUrls() { /*...*/ }
        const logContainer = document.getElementById('log-container');
        function log(message, color = '#fff') { /*...*/ }
        async function fetchAndDisplayPackages() { /*...*/ }
        function renderPackageList(packages) { /*...*/ }
        function toggleAll(source) { /*...*/ }

        // D√°n c√°c h√†m kh√¥ng ƒë·ªïi v√†o ƒë√¢y
        window.onload = function() {
            document.getElementById('cookie').value = localStorage.getItem('cookie') || '';
            document.getElementById('registerWorkerUrl').value = localStorage.getItem('registerWorkerUrl') || '';
            document.getElementById('confirmWorkerUrl').value = localStorage.getItem('confirmWorkerUrl') || '';
        }
        function saveConfig() {
            localStorage.setItem('cookie', document.getElementById('cookie').value);
            localStorage.setItem('registerWorkerUrl', document.getElementById('registerWorkerUrl').value);
            localStorage.setItem('confirmWorkerUrl', document.getElementById('confirmWorkerUrl').value);
        }
        function toggleCustomUrls() {
            document.getElementById('custom-urls').classList.toggle('hidden');
        }
        function getWorkerUrls() {
            const customRegisterUrl = document.getElementById('registerWorkerUrl').value.trim();
            const customConfirmUrl = document.getElementById('confirmWorkerUrl').value.trim();
            return {
                register: (customRegisterUrl || DEFAULT_REGISTER_URL).replace(/\/$/, ""),
                confirm: (customConfirmUrl || DEFAULT_CONFIRM_URL).replace(/\/$/, "")
            };
        }
        function log(message, color = '#fff') {
            const time = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<span style="color: #888;">[${time}]</span> <span style="color: ${color};">${message}</span>\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        async function fetchAndDisplayPackages() {
            const urls = getWorkerUrls();
            const cookie = document.getElementById('cookie').value.trim();
            const group = document.getElementById('packageGroup').value.trim();
            if (!urls.confirm || !cookie || !group) return alert("Vui l√≤ng nh·∫≠p Cookie v√† Package Group.");
            log(`üîç ƒêang t·∫£i danh s√°ch cho group: ${group}`, '#0ff');
            try {
                const response = await fetch(`${urls.confirm}/api/get-packages?group=${group}`, { headers: { 'X-MES-Cookie': cookie } });
                if (!response.ok) throw new Error(`Server b√°o l·ªói: ${response.status}`);
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                renderPackageList(data);
                log(`‚úÖ ƒê√£ t·∫£i ${data.length} package.`, '#0f0');
            } catch (e) {
                log(`‚ùå L·ªói t·∫£i danh s√°ch: ${e.message}`, '#f00');
            }
        }
        function renderPackageList(packages) {
            const container = document.getElementById('package-list');
            if (packages.length === 0) {
                container.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y package n√†o.</p>";
                document.getElementById('action-buttons').style.display = 'none';
                return;
            }
            let tableHTML = `<table><thead><tr><th><input type="checkbox" onchange="toggleAll(this)"></th><th>MxPackage</th><th>Status G·ªëc</th><th>Register Status</th><th>Final Confirm Status</th></tr></thead><tbody>`;
            packages.forEach(pkg => {
                tableHTML += `<tr id="row-${pkg.SeqNo}"><td><input type="checkbox" class="pkg-checkbox" data-pkg-name="${pkg.MxPackage}" data-seq="${pkg.SeqNo}"></td><td>${pkg.MxPackage}</td><td>${pkg.StatusName}</td><td id="register-status-${pkg.SeqNo}" class="status-icon">--</td><td id="confirm-status-${pkg.SeqNo}" class="status-icon">--</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            document.getElementById('action-buttons').style.display = 'block';
        }
        function toggleAll(source) {
            document.querySelectorAll('.pkg-checkbox').forEach(checkbox => checkbox.checked = source.checked);
        }

        async function runFullProcess() {
            const urls = getWorkerUrls();
            const cookie = document.getElementById('cookie').value.trim();
            const group = document.getElementById('packageGroup').value.trim();
            const selected = document.querySelectorAll('.pkg-checkbox:checked');

            if (selected.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt package.");
            
            log(`üöÄ B·∫Øt ƒë·∫ßu quy tr√¨nh cho ${selected.length} package...`, '#ff0');
            const mainBtn = document.querySelector('.main-action');
            mainBtn.disabled = true;

            for (const checkbox of selected) {
                const pkgName = checkbox.dataset.pkgName;
                const seqNo = checkbox.dataset.seq;
                const registerStatusCell = document.getElementById(`register-status-${seqNo}`);
                const confirmStatusCell = document.getElementById(`confirm-status-${seqNo}`);
                
                let registerSuccess = false;

                // --- B∆∞·ªõc 1: Auto Register ---
                log(`[${pkgName}] B∆∞·ªõc 1: B·∫Øt ƒë·∫ßu Register...`, '#fff');
                registerStatusCell.innerHTML = '‚è≥';
                try {
                    const response = await fetch(`${urls.register}/api/auto-register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-MES-Cookie': cookie },
                        body: JSON.stringify({ package: pkgName })
                    });
                    const result = await response.json();
                    
                    // *** THAY ƒê·ªîI 2: Hi·ªÉn th·ªã l·ªói chi ti·∫øt ***
                    if (result.ok) {
                        log(`[${pkgName}] ‚úÖ Register th√†nh c√¥ng: ${result.message}`, '#0f0');
                        registerStatusCell.innerHTML = '‚úÖ';
                        registerSuccess = true;
                    } else {
                        // In ra l·ªói c·ª• th·ªÉ t·ª´ worker
                        log(`[${pkgName}] ‚ùå Register th·∫•t b·∫°i: ${result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, '#f00');
                        registerStatusCell.innerHTML = '‚ùå';
                    }
                } catch(e) {
                    log(`[${pkgName}] üí• L·ªói h·ªá th·ªëng khi Register: ${e.message}`, '#f00');
                    registerStatusCell.innerHTML = 'üí•';
                }

                // --- B∆∞·ªõc 2: Final Confirm (ch·ªâ ch·∫°y n·∫øu b∆∞·ªõc 1 th√†nh c√¥ng) ---
                if (registerSuccess) {
                    // *** THAY ƒê·ªîI 3: Th√™m delay tr∆∞·ªõc b∆∞·ªõc 2 ***
                    log(`[${pkgName}] ‚è≥ Ch·ªù 2 gi√¢y tr∆∞·ªõc khi Confirm...`, '#888');
                    await delay(2000); // Ch·ªù 2 gi√¢y

                    log(`[${pkgName}] B∆∞·ªõc 2: B·∫Øt ƒë·∫ßu Final Confirm...`, '#fff');
                    confirmStatusCell.innerHTML = '‚è≥';
                    try {
                        const response = await fetch(`${urls.confirm}/api/confirm`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-MES-Cookie': cookie },
                            body: JSON.stringify({ packageGroup: group, seqNo: parseInt(seqNo) })
                        });
                        const result = await response.json();
                        if (result.ok) {
                            log(`[${pkgName}] ‚úÖ Final Confirm th√†nh c√¥ng!`, '#0f0');
                            confirmStatusCell.innerHTML = '‚úÖ';
                        } else {
                            log(`[${pkgName}] ‚ùå Final Confirm th·∫•t b·∫°i: ${result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, '#f00');
                            confirmStatusCell.innerHTML = '‚ùå';
                        }
                    } catch(e) {
                        log(`[${pkgName}] üí• L·ªói h·ªá th·ªëng khi Final Confirm: ${e.message}`, '#f00');
                        confirmStatusCell.innerHTML = 'üí•';
                    }
                } else {
                     log(`[${pkgName}] ‚è© B·ªè qua b∆∞·ªõc Final Confirm do Register th·∫•t b·∫°i.`, '#ff0');
                     confirmStatusCell.innerHTML = '‚è©';
                }
                 log('--------------------------------', '#888');
            }
            
            log(`üéâ QUY TR√åNH HO√ÄN T·∫§T!`, '#ff0');
            mainBtn.disabled = false;
        }
    </script>
</body>
</html>
